\newpage

% Из текста короткого задания на ВКР:
% 1. Проанализировать технологии, используемые для реализации бесконтактного взаимодействия платежного терминала и средства платежа (карты, смартфона и пр.).
% 2. Проанализировать методы и инструменты обеспечения безопасности бесконтактных платежей
% -. Сравнение существующих аналогов систем коррекции
% -. Выбор методы и технологий разработки системы


%  - Как технически выглядит процесс оплаты (от введения суммы и прикладывания карты, до отображения статуса платежа)
%  - Декомпозиция процесса на технологии, используемые на разных этапах
%  - Обзор технологий
%    - с точки зрения тех. процесса
%    - с точки зрения безопасности
%  - Сравнительный анализ существующих решений
%  - Формирование требований к системе (используемые технологии, превосходство над аналогами)

\section{Анализ предметной области}

\subsection{Развитие сферы банковских платежей}

\subsubsection{Эволюция платежных операций}

Появление банковской системы, выступающей в качестве посредника между государством и гражданами, ознаменовало процесс непрерывного развития финансовых технологий, поскольку банки стремились повысить свою прибыльность, в том числе путем повышения качества платежных сервисов.
Деньги выступали в качестве основного способа оплаты товаров и услуг, однако не всегда были удобным способом оплаты, поэтому в дополнение к ним сначала появились бумажные чеки, а позднее и банковские карты.
Вместе с появлением банковских карт, появились и платежные системы~-- инстанции, которые не только выпускали и поддерживали карты, но и выступали посредниками между банками.
Для приема карт к оплате необходимы были специальные устройства.
Изначально это были импринтер, с помощью которого создавались слипы~-- бумаги, содержащие реквизиты карты, дату и сумму покупки и др..
Ему на смену пришел электронный терминал оплаты (POS-терминал), который упрощал взаимодействие с картой, т.к. передавал информацию о карте напрямую в процессиноговые центры платежной системы.

При приеме карты кассир должен был получить информацию от банка, что у держателя карты есть необходимый объем денежных средств для оплаты, в противном случае товар или услуга не могла быть оплачена.
Изначально этот процесс выглядел следующим образом: кассир звонил в банк-эквайер, тот связывался с банком-эмитентом, выпустившем карту, который подтверждал наличие необходимой суммы и инициировал ее передачу в банк-эквайер либо сообщал о невозможности оплаты.
Платежные системы изначально выступали каналом связи между банками.
Однако с увеличением количества карт создавалась высокая нагрузка на банки, и с целью ее снижения появились специальные процессинговые центры, которые совместно с платежными системами осуществляли функцию клиринга~\cite{habr_fondy_payment_history}.

Клиринг~-- это комплекс взаиморасчётов за оказанные услуги, проданные товары или ценные бумаги, основанные на безналичных расчётах.
Клиринг в платёжной системе~-- это взаиморасчёты по любым операциям, совершённым с помощью банковской карты.
Функцию клиринга выполняет ПС, за счет нее снижается нагрузка на банки, выступающие в роли эквайеров, т.к. ПС переводит им деньги в конце операционного дня~\cite{habr_nspk_cliring}.

Процесс идентификации голосом постепенно ускорялся, за счет повышения стабильности и качества телефонии.
Однако с ужесточением требованием ПС к времени подтверждения транзакции и развития банковских алгоритмов ему на смену пришла авторизация по пин-коду, которая является актуальной технологией на данный момент.
ПС совместно с банками продолжают развивать технологию авторизации, в результате чего сейчас для выполнения платежных операций, не превышающих определенный лимит, не требуется пин-код.

Также на текущий момент в России активно развивается оплата посредством QR-кодов, предоставляемых Системой Быстрых Платежей (СБП) и/или банками-эквайерами.
Данная технология не новая, однако оказалась востребованной среди пользователей, поскольку для оплаты по QR подойдет любое мобильное устройство с камерой и выходом в интернет. 
А после наложения на Россию санкций в 2022-м году смартфоны под управлением ОС IOS лишились возможности оплаты посредством NFC, и оплата по QR-коду стала единственно-возможным вариантом~\cite{habr_nspk_qr}.


\subsubsection{Эволюция банковских карт}

Банковские карты так же, как и сами платежные операции, претерпели ряд изменений.
Сначала в них появилась магнитная полоса для быстрой идентификации карты платежным терминалам с помощью статических данных, хранимых в карте.
В 1993 году международные платёжные системы Mastercard, Visa и Europay подписали соглашение о совместной работе, чтобы развить технологии банковских карт.
В результате чего в 1994 году была выпущена первая версия стандарта EMV и систем на его основе.

Данный стандарт предусматривал наличие специального EMV-чипа, встроенного в карты.
Данный чип~--- это микропроцессор, предназначенный для безопасного хранения и обработки данных при проведении платежных операций.
В отличие от традиционной магнитной полосы, которая содержит статичные данные и легко подделывается, EMV-чип генерирует уникальный криптографический код для каждой транзакции, что делает её практически невозможной для подделки~\cite{emv_specifications_book}.

EMV-стандарт был внедрен с целью глобального повышения безопасности безналичных платежей и снижения уровня подделки карт и кражи их данных.
EMV-стандарт ввел понятие офлайн транзакции~-- платежной операции исключительно с участием карты и платежного терминала, которые проводит ее аутентификацию.
В онлайн транзакции терминал связывается в режиме реального времени с банком-эквайером, который через ПС запрашивает аутентификацию карту у банка-эмитента.

После массового внедрения EMV-карт во многих странах наблюдалось значительное снижение случаев фрода с использованием поддельных карт~\cite{plas_emv_fraud}.
Фрод~-- это проведение мошеннических (неправомерных) операций с использованием банковских карт.
Кроме того, EMV-чип лег в основу технологий бесконтактной оплаты, таких как PayPass (Mastercard), payWave (Visa) и Mir Accept (НСПК), где также используется принцип одноразовых криптограмм.
Бесконтактные карты используют технологию радичастотной модуляции сигнала (RFID), с использованием антенны, встроенной в карту, представленной на рисунке~\ref{fig:emv_card}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.4\textwidth]{images/research/emv_card}
    \caption{\centering Структура бесконтактной EMV-карты}
    \label{fig:emv_card}
\end{figure}

С распространением технологии NFC появилась сфера мобильных платежей.
Покупатели получили возможность быстро и безопасно выполнять оплату посредством устройств с поддержкой NFC с помощью виртуальных карт, добавленных в приложение «цифрового кошелька».
Примеры подобных приложений: Apple Pay, Google Pay, Mir Pay и др..


\subsection{Анализ процесса платежа через терминал}

\subsubsection{Оплата бесконтактной картой}
\label{subsubsec:contactless_payment}

Процесс оплаты с использованием бесконтактной банковской карты может протекать несколькими различными способами.
Как уже было упомянуто ранее, есть онлайн и офлайн оплата через терминал.
Первая происходит с запросом подтверждения банком-эквайера от банка-эмитента в реальном времени.
Вторая происходит исключительно без моментального подтверждения банком, с участием карты и платежного терминала, который проводит ее аутентификацию.
Также для оплаты могут использоваться разные типы карт.
Однако именно бесконтактную оплату поддерживается только картами, соответствующими стандарту EMV.

При этом карта в защищенной области памяти хранит общий с эмитентом ключ MK-AC (Application Cryptogram Master Key).
Во время совершения оплаты при онлайн-операции карта генерирует на основе MK-AC сессионный ключ SK-AC (Application Cryptogram Session Key) и использует его, данные карты и данные об операции, полученные с терминала, для генерации криптограммы операции ARQC (Authorization Request Cryptogram).
В основе генерации криптограммы лежит алгоритм 3DES (Triple DES).
В общем случае данные по операции поступают от карты к платежному терминалу, далее на хост банка-эквайера, затем к платежной системе и на самом последнем этапе к банку-эмитенту для авторизации.
Результат авторизации передается назад на платежный терминал и карту.
Данный процесс изображен на рисунке~\ref{fig:emv_card_payment}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_card_payment}
    \caption{\centering Процесс оплаты посредством EMV-карты}
    \label{fig:emv_card_payment}
\end{figure}

Банк-эмитент проверяет пришедшую криптограмму операции, путем ее сравнения со значением, которое генерирует сам на основе данных об операции, пришедших вместе с ARQC.
Банк-эмитент может одобрить или отклонить операцию по результатам анализа данных карты, криптограммы, установленных лимитов операций, рисков, а также других параметров~\cite{habr_nspk_mir_payment}.

Далее банк-эмитент на основе динамических данных транзакции генерирует ARPC (Authorisation Response Cryptogram) и отправляет эту криптограмму карте.
В тот момент, когда карта подтвердит пришедший ARPC, взаимная аутентификация карты и эмитента – выполнена~\cite{emv_card_mechanism}.


\subsubsection{Оплата мобильным приложением-кошельком}

При оплате мобильным кошельком выданная банком-эмитентом карта непосредственного участия в оплате не принимает.
Держатель карты вносит данные карты в цифровой кошелек, после чего карта «добавляется» в приложение, точнее не она, а специальный токен-профайл, сгенерированный на базе этой карты.
При этом карточные данные и ключ эмитента MK-AC, хранимый на карте, на телефон не передаются, поэтому оплата посредством приложения происходит с использованием токен-профайла и его специальных ключей.

Процесс добавления карты в приложение-кошелек представлен на рисунке~\ref{fig:add_mob_cardholder}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/add_mob_cardholder}
    \caption{\centering Процесс оплаты посредством мобильного приложения-кошелька}
    \label{fig:add_mob_cardholder}
\end{figure}

Цифрами на рисунке~\ref{fig:add_mob_cardholder} обозначены следующие этапы добавления карты в кошелек:

\begin{enumerate}
    \item держатель карты вводит данные в приложение;
    \item приложение передает их в зашифрованном виде через поставщика услуг мобильного кошелька(WSP~-- Wallet Service Provider) в платежную систему (в случае приложения Mir Pay поставщиком услуг кошелька является НСПК~-- Национальная система платежных карт~-- поэтому данные сразу попадают в ПС);
    \item платформа мобильных платежей (ПМП) производит обработку данных: расшифровывает их, по номеру карты определяет, каким эмитентом она была выдана, и запрашивает у него подтверждение на возможность добавления карты в кошелек;
    \item банк-эмитент возвращает подтверждение или запрет на возможность добавления карты в кошелек;
    \item в случае получения подтверждения для данной карты происходит процедура генерации токен-профайла;
    \item передачи токен-профайла в мобильное приложение пользователя;
    \item мобильное приложение запрашивает у ПМП несколько одноразовых ключей, которые будут использоваться приложением при совершении покупки в качестве сессионных ключей для проведения операции, аналогичных SK-AC.
\end{enumerate}

Таким образом, вместо карточных данных на мобильном устройстве будет храниться токен-профайл, который привязан к конкретным карте и устройству.
Преобразование токен-профайла в исходные данные карты вне платформы мобильных платежей является невозможным.
Одноразовые ключи не могут быть применены более одного раза, поэтому в процессе использования мобильное приложение с некоторой периодичностью подгружает из ПМП новые ключи.


Стоит отметить, что в Mir Pay используется схема, при которой происходит хранение нескольких одноразовых ключей, но существует и другой подход, при котором происходит хранение одного ключа на устройстве.
Такой подход требует наличия аппаратного элементов безопасности (АЭБ) на устройстве, например TEE (Trusted Execution Environment) или SE (Secure Element), и некоторые кошельки применяют именного этот подход, однако он накладывает ограничение в виде наличия АЭБ в устройстве.
Mir Pay также использует АЭБ при его наличии, но уже для хранения одноразовых ключей.

Высокая степень безопасности при использовании приложения гарантируется тем, что для обмена конфиденциальными данными ПМП и Mir Pay генерируют ключевые пары и обмениваются лишь публичными компонентами.
При этом хранением разных ключевых компонент происходит в разных системных хранилищах: как в ключевом хранилище, так и в оперативной памяти.
Для совершения мошеннической операции придется извлечь и расшифровать криптограммы всех ключей, а это неэффективно, в силу того, что для проведения операций используются строго одноразовые ключи.
Передача конфиденциальных данных, например токен-профайла, одноразовых ключей для проведения операций и данных по уже совершенным операциям, начинается только после того, как Mir Pay и ПМП обменялись публичными ключами, создав защищенный канал, и происходит только с использованием <<крипто-стойких>> алгоритмов~\cite{habr_nspk_mir_payment}.

Процесс оплаты с помощью приложения кошелька представлен на рисунке~\ref{fig:emv_mob_payment}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_mob_payment}
    \caption{\centering Процесс оплаты посредством мобильного приложения-кошелька}
    \label{fig:emv_mob_payment}
\end{figure}

При оплате с помощью мобильного приложения-кошелька используются данные токен-профайла, а криптограмма ARQC генерируется на основе одного из одноразовых ключей (вместо SK-AC как при оплате картой).
Также при оплате приложением может использовать алгоритм шифрования, отличный от 3DES.
В частности в Mir Pay для генерации криптограммы используется более современный симметричный алгоритм блочного шифрования AES (Advanced Encryption Standard).

После генерации ARQC данные об операции так же, как и при оплате банковской картой, проходят через терминал и хост банка-эквайера, попадая в платежную систему.
По наличию токена и его номеру (из токен-профайла) платежная система определяет, что производится полата с помощью мобильного приложения, и направляет данные операции в ПМП для проверки криптограммы и детокенизации~-- превращения токена в данные соответствующей банковской карты.
Данные операции вместе с данными карты отправляются для авторизации в банк-эмитент.
После чего на основе ответа банка-эмитента запускается процесс обратного преобразования платежных данных.

Отличие от оплаты картой как раз в том, что криптограмма проверяется не эмитентом, а ПМП, так как одноразовые ключи и токен-профайл генерируются именно в в платформе мобильных платежей~\cite{habr_nspk_mir_payment}.


\subsection{Анализ платежных технологий}

В предыдущем подразделе были рассмотрены стандартные сценарии выполнения платежных операций.
Отдельное внимание хочется уделить процессам взаимодействия платежного терминала с банковской карты или мобильного платежного приложения и с хостом банка-эквайера.
С целью детального анализа происходящих процессов и используемых в них технологий.

Наиболее важным в данном контексте является стандарт EMV, т.к. он описывает характеристики банковских карт и других средств бесконтактной оплаты, а также весь процесс формирования платежа.

\subsubsection{Стандарт EMV}

EMV~--- стандарт для банковских карт, совместно разработанный платежными системами Europay, Mastercard и Visa.
Он используется  международными платежными системами (МПС) для проведения операций по банковским картам.

Повышенный уровень безопасности карт стандарта EMV обусловлен наличием встроенного чипа, который называется Secure Element.
Чип хранит данные в зашифрованном формате, а также может запускать приложения на карте и обмениваться командами с кассовыми терминалами.

Банковская карта с поддержкой стандарта EMV, является стандартной смарт-картой, однако, имеет расширенный и специфичный функционал.
Технология ее функционирования и работы с ней описана в стандарте ISO/IEC 7816.
Технология работы с бесконтактной картой описана в стандарте ISO/IEC 14443.
Карта имеет операционную систему со встроенной файловой системой и приложениями, причем предназначенными не только для реализации платежей~\cite{emv_specifications_book}.


\paragraph{EMV-карта}

Главное новшество EMV-карт~--- возможность проверки динамической криптограммы карты (цифровой подписи ее статических данных).
Для карт с магнитной полосой терминалы не имели такую возможность и выполняли проверку только статических данных карты, в результате чего такие карты легко копировались.
Процесс аутентификации карты с магнитной полосой и EMV-карты представлен на рисунках~\ref{fig:magnetic_card_auth} и~\ref{fig:emv_card_auth} соответственно.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/magnetic_card_auth}
    \caption{\centering Аутентификации карты с магнитной полосой в ходе платежной транзакции}
    \label{fig:magnetic_card_auth}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_card_auth}
    \caption{\centering Аутентификации EMV-карты на основе динамической криптограммы в ходе платежной транзакции}
    \label{fig:emv_card_auth}
\end{figure}

Динамическая аутентификация карты в ходе EMV-транзакции происходит по следующему алгоритму:

\begin{enumerate}
    \item терминал передает данных о транзакции на карту (сумма, валюта, страна и пр.);
    \item происходит проверки рисков транзакции как картой, так и терминалом;
    \item если проверка не пройдена на карте, то процесс прерывается, если пройдена~-- карта подписывает данные транзакции;
    \item терминал помечает полученными от карты данные тегом <<DE 55>> (стандарт ISO 8583) и отправляет вместе с прочими в банк-эквайер;
    \item банк-эмитент выполняет проверку динамической подписи транзакции.
\end{enumerate}


Данные в Field/DE 55 содержится важная информация для оценки рисков транзакции  эмитентом и ПС, в частности Terminal Verification Result и Сard Verification Result~\cite{emv_card_mechanism}.
Полный список передаваемых данных представлен на рисунке~\ref{fig:de55}.

\begin{figure}
    \centering
    \includegraphics[width=0.4\textwidth]{images/research/de55}
    \caption{\centering Данные в Field/DE 55}
    \label{fig:de55}
\end{figure}

Банк-эмитент также может выслать свою криптограмму карте для дополнительной аутентификации или обновить данные карты (например, лимит карты), записанные на чипе карты (уже после успешной аутентификации)~\cite{emv_book_2}.
Более подробно процесс формирования и проверки криптограммы уже был описан в пункте~\ref{subsubsec:contactless_payment}.


\paragraph{Платежные EMV-приложения}

Платежное EMV-приложение выступает в качестве интерфейса для взаимодействия с картой.
С помощью серии команд, поданных в приложение на карте осуществляется управление приложением и состоянием транзакции.

Для работы с приложениями на карте используются APDU-команды, описанные в стандарте ISO/IEC 7816--4.
С их помощью реализуется функционал приложения, например, создание банковской транзакции и управление ее состоянием.
Стоит также отметить, что производители карты реализуют свои собственные приложения для оплаты, реализуя при этом стандарт выполнения платежа в EMV, который называется EMV Transaction Flow, о нем речь пойдет в подпункте~\ref{par:emv_transaction}.

Каждое приложение имеет свой собственный идентификатор~--- AID (Application Identifier).
Он указывает к какому типу ПС относится приложение и для каких карт может использоваться (для карт одной ПС, могут использоваться разные приложения).
На основе идентификатора приложения AID терминал определяет возможность проведения транзакции или, в случае нескольких приложений, составляет список поддерживаемых приложений и предлагает выбрать одно из них для выполнение транзакции~\cite{emv_card_mechanism}.


\paragraph{Безопасность EMV-карты}

Любые смарт-карты, и EMV-карты не исключение, имеют механизм разграничения доступа, с помощью которого происходит контроль состояния карты в рамках текущей сессии подключения и механизм проверки условий доступа, другими словами, проверка прав на работу с файлами.
Наличие прав зависит от состояния карты в рамках текущей сессии, которое может изменяться вводом определенных предварительно заложенных кодов доступа~\cite{habr_smart_card_for_little}.

Также смарт-карты имеют встроенные механизмы для шифрования, однако их аппаратная реализация отличается в зависимости от производителя.
В EMV-чипах реализованы следующие алгоритмы шифрования:

\begin{itemize}
    \item RSA (асимметричное шифрование): применяется в EMV-картах для аутентификации и защиты данных, используется для динамической аутентификации (DDA) и комбинированной аутентификации (CDA), обеспечивая высокий уровень безопасности за счет генерации уникальных ключей для каждой транзакции;
    \item DES и 3DES (симметричное шифрование): DES - устаревший и менее безопасный стандарт, однако по-прежнему применяемый в некоторых системах, более распространенным является 3DES (Triple DES), который обеспечивает улучшенную безопасность за счет применения алгоритма DES трижды, эти алгоритмы используются для шифрования PIN-кодов;% TODO добавить ссылку на раздел про DES
    \item AES (Advanced Encryption Standard): современный симметричный алгоритм шифрования, предлагающий более высокий уровень безопасности по сравнению с DES и 3DES, благодаря более длинным ключам и более сложным методам шифрования, используется в технологии HCE (Host Card Emulation) для шифрования в приложениях <<Цифровых кошельках>> на мобильных устройствах;
    \item SHA-1 и SHA-256 (хэширование): используется для создания хэш-значений транзакций, из-за уязвимостей SHA-1 многие системы переходят на SHA-256, который обеспечивает более высокий уровень безопасности, с помощью хэш-функции гарантируется целостность данных в процессе транзакций~\cite{emv_fastercapital}.
\end{itemize}

Важно понимать, что персональная информация владельца карты в платежных приложениях не хранится, а сами приложения, ключи и некоторые PIN-коды, защищены от прямого доступа и модификации.
Однако, информация, не относящаяся к конфиденциальным данным, является доступной.
К подобной информации относятся различные данные, необходимые для выполнения платежных операций, в частности сертификаты ключей-доступа, номер карты (PAN), списки методов проверки карты (CVM~-- Card Verification Methods list) и другая информация.
Примерный перечень всех доступных для чтения данных приложения приведен на рисунке~\ref{fig:emv_available_data}.
Доступные данные организованы в записи (рекорды или треки), которые можно получить с помощью команд «Get Processing Options» и «Read Record», описанных  в ISO/IEC 7816.
Дополнительно данные технических настроек, таких как лимиты и счетчики, могут быть доступны через команду «Get Data» с указанием требуемого типа~\cite{emv_card_mechanism}.

% TODO: need [H]?
\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_available_data}
    \caption{\centering Доступные данные платженого EMV-приложения}
    \label{fig:emv_available_data}
\end{figure}

Банковская платежная карта имеет несколько уровней защиты, определенных хронологией ее создания:

\begin{enumerate}
    \item производитель чипа карты задает некий первичный ключ для доступа к прошивке карты, с помощью него можно установить ОС;
    \item ОС карты также имеет свой ключ, который необходим для работы с файлами и приложениями на карте, с помощью него можно установить платежные приложения;
    \item платежные приложения на карте персонализируются с помощью определенных параметров и ключей приложения, заложенных банком-эмитентом с целью обеспечения безопасности EMV-транзакций.
\end{enumerate}

После чего, как правило, изменение работы карты и приложения становится практически невозможным без знания ключей.
Данные платежного приложения могут модифицироваться после выпуска карты посредством банкомата или терминала, которые после успешной аутентификации карты в ходе банковской транзакции, передает скриптовую командой, имеющую цифровую MAC-подписью, гарантирующей целостность данных.
Такая возможность предусмотрена для того, чтобы  банк-эмитент управлять блокировкой карты, обновлять лимиты или настройки.
В данном случае, MAC~--- это аналог цифровой подписи, который гарантирует целостность данных, переданных на карту. 
Для его расчета используется соответствующий ключ приложения (один из 3-х DES ключей загружаемых в приложение).
% TODO добавить ссылку на раздел про DES

Технически возможно перенести данные с одной банковской карты на другую, если приложение на новой карте не персонализировано.
Однако отсутствие возможности доступа, а, как следствие, и копирования ключей делает карту неприменимой для проведения транзакций, т.к. без них приложение не сможет сгенерировать корректную подпись транзакции, что приведет к отклонению операции банком-эмитентом.
Кроме того, невозможность выполнить CDA (Combined Data Authentication) или DDA (Dynamic Data Authentication) существенно ограничивает использование копии.
Единственным уязвимым местом может быть SDA (Static Data Authentication), однако этот метод уже считается устаревшим и редко используется как единственный механизм аутентификации~\cite{emv_card_mechanism}.


\paragraph{EMV-транзакция}
\label{par:emv_transaction}

В пункте~\ref{subsubsec:contactless_payment} уже упоминалось о существовании 2-х типов платежный транзакций: онлайн и офлайн, а также в общих чертах было рассмотрено выполнение онлайн транзакции.
Для каждого типа транзакции предусматривает соответствующий способ аутентификации.
В случае онлайн-транзакции верификация проводится при непосредственном участии эмитента.
Офлайн-аутентификация, в свою очередь, выполняется самим платежным терминалом.
Важно отметить, что при обработке онлайн-операции могут одновременно использоваться как онлайн, так и офлайн аутентификация, если карта и терминал поддерживают оба метода.
И это не является избыточным действием, т.к. на этапе аутентификации не всегда определено, в каком режиме будет осуществляться транзакция.

Любая платежная транзакция в соответствии со стандартом EMV начинается с выбора платежного приложения на терминале.
После выбора приложения терминал и карта выполняют ряд функций, которые схематично представлены на рисунке~\ref{fig:transaction_flow_example} в порядке своего выполнения.
Для каждой функции есть условия и ограничения применения, которые детально описываются стандартом.
В соответствии с EMV стандартом терминал во время транзакции должен выполнять только те функции, которые поддерживаются конкретной платежной картой~\cite{emv_book_3}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/transaction_flow_example}
    \caption{\centering Схема алгоритма выполнения транзакции терминалом}
    \label{fig:transaction_flow_example}
\end{figure}

За безопасность проведения транзакции отвечают следующие этапы:

\begin{itemize}
    \item аутентификация (офлайн, онлайн или комбинированная);
    \item оценка рисков проведения транзакции;
    \item верификация держателя карты на основе онлайн и офлайн пин-кода, размера суммы транзакции, страны, валюты и прочих данных;
\end{itemize}

% TODO: заменить на корректное что-то, что меньше подпункта
\paragraphit{Онлайн аутентификация}

Процесс выполнения онлайн аутентификации представлен на рисунке~\ref{fig:online_auth}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/online_auth}
    \caption{\centering Процесс выполнения онлайн аутентификации}
    \label{fig:online_auth}
\end{figure}

Его описание было приведено в пункте~\ref{subsubsec:contactless_payment}.

% TODO: заменить на корректное что-то, что меньше подпункта
\paragraphit{Офлайн аутентификация}

Как уже отмечалось ранее офлайн аутентификация происходит без непосредственного взаимодействия с банком или ПС в момент совершения операции.
Карта и терминал могут самостоятельно одобрить транзакцию, если её сумма не превышает установленный лимит.
Терминал же передает информацию в банк в соответствии с установленным режимом.
Преимущества данного подхода в том, что держатель карты может завершить оплату при отсутствии связи с банком, и операции на небольшие суммы выполняются значительно быстрее.

Офлайн аутентификация происходит с использованием асимметричной криптографии RSA.
Основная причина использования RSA заключается в распределении ключей: в онлайн-транзакциях ключи известны только карте и банку, тогда как в офлайн-процессе терминал также должен иметь доступ к ключу.
С учетом большого количества терминалов, повышается вероятность компрометации секретного ключа, что делает асимметричный подход более безопасным, т.к. терминал хранит только открытый ключ, а карта - секретный ключ.

Упрощенная модель статической аутентификации (Static Data Authentication) представлена на рисунке~\ref{fig:sda}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/sda}
    \caption{\centering Упрощенная модель Static Data Authentication (SDA)}
    \label{fig:sda}
\end{figure}

Центральную роль в этом процессе играет ПС, выступающая в качестве сертификационного центра, она создает пару ключей: секретный (красный) и открытый (синий).
Аналогичную пару ключей генерирует банк-эмитент.
Публичный ключ эмитента включается в специальный сертификат (Issuer Public Key Certificate), подписанный с использованием приватного ключа ПС.
Данный сертификат загружается на карту в процессе ее персонализации.

Когда платежный терминал подключается к торговой точке, в него загружается публичный ключ ПС через банк-эквайер.

Во время выполнения офлайн транзакции терминал осуществляет аутентификацию карты по следующему алгоритму:

\begin{enumerate}
    \item терминал считывает сертификат (Issuer Public Key Certificate) с карты и с помощью публичного ключа ПС проверяет его подпись;
    \item если подпись сертификата подтверждена, терминал извлекает публичный ключ банка-эмитента из сертификата;
    \item данный ключ используется для проверки подписи критически важных данных карты, что позволяет удостовериться в её подлинности.
\end{enumerate}

Описание выполнение SDA из стандарта EMV приведено на рисунке~\ref{fig:emv_offline_sda}~\cite{emv_book_2}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_offline_sda}
    \caption{\centering Диаграмма Static Data Authentication (SDA)}
    \label{fig:emv_offline_sda}
\end{figure}

SDA в настоящее время уступает место более современным технологиям DDA (Dynamic Data Authentication) и CDA (Combined Data Authentication).
Эти методы включают в себя SDA, но также используют динамическое подписание данных, передаваемых между терминалом и картой.

Технология SDA позволяет удостовериться в неизменности данных на карте, но не обеспечивает полной защиты от копирования.
В отличие от неё, DDA и CDA подтверждают подлинность карты, поскольку карта хранит уникальный приватный ключ.
Сертификат этого ключа подписан приватным ключом эмитента, а сертификат эмитента~-- приватным ключом платежной системы.

DDA и CDA схожи по структуре: оба используют уникальный ключ карты и динамические данные.
Однако DDA выполняется как отдельная операция до начала основной транзакции, тогда как CDA интегрирована в транзакционный процесс и дополнительно подписывает криптограмму карты.
Несмотря на то, что CDA обеспечивает более высокий уровень безопасности, на практике чаще применяется DDA.

Описание выполнение офлайн DDA и CDA из стандарта EMV приведено на рисунке~\ref{fig:emv_offline_dda_cda}~\cite{emv_book_2}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_offline_dda_cda}
    \caption{\centering Диаграмма офлайн DDA и CDA}
    \label{fig:emv_offline_dda_cda}
\end{figure}

Также существует алгоритм офлайн DDA с использованием криптографии эллиптических кривых (Elliptic Curve Cryptography~-- ECC), который называется
Extended Data Authentication (XDA).

Описание выполнение офлайн XDA стандарта EMV приведено на рисунке~\ref{fig:emv_offline_xda}~\cite{emv_book_2}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_offline_xda}
    \caption{\centering Диаграмма офлайн XDA}
    \label{fig:emv_offline_xda}
\end{figure}


При выполнении XDA карта генерирует цифровую подпись, которая проверяется терминалом.
Эта подпись аутентифицирует карту и подтверждает подлинность кода аутентификации приложения (Application Cryptogram, AC), а также других критически важных данных, переданных картой и терминалом.
Это делает невозможным создание поддельной карты и обеспечивает целостность данных между картой и терминалом.

Для реализации XDA необходимо наличие центрального удостоверяющего центра (Certification Authority)~--- высоко защищённого криптографического устройства, которое подписывает открытые ключи эмитента.
Если приложение терминала поддерживает XDA, то оно должно содержать соответствующие открытые ключи удостоверяющего центра для данного приложения.


\paragraph{Проверки безопасности транзакции}

Карты и терминалы также оценивают риски транзакций.
Для офлайн транзакций карта использует счетчики операций, лимиты сумм, правила проверки PIN-кода, а также другие параметры.
Эмитент может ограничивать количество последовательных офлайн операций или их максимальную сумму, устанавливая уровень риска.

Каждая платежная система имеет собственный набор правил для принятия решений о проведении транзакции в офлайн или онлайн режиме либо её отклонении.
Эти правила, настраиваемые эмитентом, учитывают результаты предыдущих операций, показатели счетчиков и лимитов, а также результаты проверки PIN-кода~\cite{secure_nfc_mc}.


В технологии EMV также применяются методы проверки держателя карты (Cardholder Verification Method, CVM).
Они сохранили основные подходы, используемые ранее в магнитных картах.
Наиболее распространены проверка PIN-кода (онлайн или офлайн) и подписи владельца карты.
Однако не все платежные терминалы поддерживают одинаковые методы проверки из-за различий в оборудовании или ограничений конкретных EMV-приложений.

Для выбора подходящего метода используются CVM-списки, которые содержат перечень методов проверки и их приоритеты.
Каждый терминал и карта имеют собственные списки, которые объединяются для формирования итогового перечня.
На его основе терминал выбирает метод с наивысшим приоритетом, поддерживаемый обеими сторонами, и осуществляет проверку.

Например, при использовании банкомата запрашивается онлайн-PIN, в терминале~--- офлайн-PIN. Если устройство не поддерживает PIN-коды, осуществляется проверка подписи.
В иных случаях проверка держателя карты может быть пропущена~\cite{emv_card_mechanism}.


\subsubsection{Стандарт ISO/IEC 14443}


\subsubsection{Стандарт ISO/IEC 7816}


\subsubsection{3DES и MirAccept}



\subsection{Анализ существующих решений}

\subsubsection{POS-терминалы}

POS-терминал (от англ.\ Point of Sale, точка продаж)~--- это устройство, предназначенное для приема безналичных платежей с использованием платежных средств, поддерживающих соответствующие терминалу технологии.
POS-терминалы широко используются в розничной торговле, ресторанах, транспорте и других сферах, где требуется осуществление платежей.

Основные функции POS-терминалов:

\begin{itemize}
    \item инициация взаимодействия с платежным средством (карта, смартфон и прочее);
    \item обмен данными с платежным средством, получение данных для формирования транзакции;
    \item связь с банком (напрямую или с помощью устройства-хоста) для авторизации и выполнения транзакций;
    \item выдача чека потребителю (в печатном или электронном виде), возврат ошибки платежа;
    \item обеспечение безопасности платежа, в соответствии со стандартом EMV.
\end{itemize}

POS-терминалы имеют различную структуру, однако можно выделить обобщенную структуру данного устройства.
Она представлена на рисунке~\ref{fig:postrem_struct}.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/research/postrem_struct}
    \caption{\centering Распространенная структура POS-терминала}
    \label{fig:postrem_struct}
\end{figure}

К обязательным элементам данного устройства можно отнести следующие:

\begin{itemize}
    \item RFID считыватель для обнаружения и связи со средствами платежа бесконтактным образом;
    \item элемент безопасности (криптографический модуль, SAM-модуль) для сохранения конфиденциальной платежной информации;
    \item модули проводной и/или беспроводной связи для связи с устройством-хостом или прямой связи с банком-эквайером.
\end{itemize}

Стоит отметить, что работа подобного устройства не возможна без программного обеспечения, интегрированного в POS-систему, которое управляет формированием и обработкой транзакций, шифрованием данных, запросами на авторизацию и связь с платежными сетями.

Мобильный эквайринг активно развивается и следствием этого явилось появление mPOS-терминалов и softPOS-терминалов:

\begin{itemize}
    \item mPOS-терминал~-- это портативное устройство, часто смартфон или планшет, оснащенное программным и аппаратным обеспечением, которое позволяет выполнять транзакции;
    \item softPOS терминал~-- это программное решение, с помощью которого мобильное устройство с поддержкой NFC (как правило смартфон или планшет) выступает в роли платежного терминала, т.е. принимает бесконтактные средства платежа, используя встроенный модуль NFC, и осуществляет выполнение платежных транзакций~\cite{pos_term}.
\end{itemize}

Детальное сравнение разновидностей POS-терминалов приведено в таблице~\ref{tab:pos_comparison}.

\begin{table}[H]
    \caption{Сравнение POS, mPOS и SoftPOS терминалов}
    \label{tab:pos_comparison}
    \begin{sloppypar}
        \centering
        \begin{tabularx}{\textwidth}{ | >{\raggedright\arraybackslash}X | >{\raggedright\arraybackslash}X | >{\raggedright\arraybackslash}X | >{\raggedright\arraybackslash}X | }
            \hline
            \textbf{Особенность} & \textbf{POS-терминалы} & \textbf{mPOS-терминалы} & \textbf{SoftPOS-терминалы} \\
            \hline
            Требования к оборудованию & специальные аппаратные компоненты & мобильное устройство с внешним считывателем карт & смартфон или планшет \\
            \hline
            Мобильность & закреплены на торговых точках & могут переносится & могут переносится \\
            \hline
            Методы оплаты & не только бесконтактные платежи & бесконтактные платежи и поддержка приложений цифровых кошельков & бесконтактные платежи и поддержка приложений цифровых кошельков \\
            \hline
            Особенности настройки & необходимость интеграции с сетью и окружением & требуется установка приложения и подключение считывателя карт & только установка приложения \\
            \hline
            Пользовательский интерфейс & отдельный экран устройства & экран мобильного устройства & экран мобильного устройства \\
            \hline
        \end{tabularx}
    \end{sloppypar}
\end{table}


\subsubsection{Сравнение существующих устройств}




\subsection{Формирование требований к системе}


