\newpage

% Из текста короткого задания на ВКР:
% 1. Проанализировать технологии, используемые для реализации бесконтактного взаимодействия платежного терминала и средства платежа (карты, смартфона и пр.).
% 2. Проанализировать методы и инструменты обеспечения безопасности бесконтактных платежей
% -. Сравнение существующих аналогов систем коррекции
% -. Выбор методы и технологий разработки системы


%  - Как технически выглядит процесс оплаты (от введения суммы и прикладывания карты, до отображения статуса платежа)
%  - Декомпозиция процесса на технологии, используемые на разных этапах
%  - Обзор технологий
%    - с точки зрения тех. процесса
%    - с точки зрения безопасности
%  - Сравнительный анализ существующих решений
%  - Формирование требований к системе (используемые технологии, превосходство над аналогами)

\section{Анализ предметной области}

\subsection{Развитие сферы банковских платежей}

\subsubsection{Развитие платежных операций}

Появление банковской системы, выступающей в качестве посредника между государством и гражданами, ознаменовало процесс непрерывного развития финансовых технологий, поскольку банки стремились повысить свою прибыльность, в том числе путем повышения качества платежных сервисов.
Деньги выступали в качестве основного способа оплаты товаров и услуг, однако не всегда были удобным способом оплаты, поэтому в дополнение к ним сначала появились бумажные чеки, а позднее и банковские карты.
Вместе с появлением банковских карт, появились и платежные системы~-- инстанции, которые не только выпускали и поддерживали карты, но и выступали посредниками между банками.
Для приема карт к оплате необходимы были специальные устройства.
Изначально это были импринтер, с помощью которого создавались слипы~-- бумаги, содержащие реквизиты карты, дату и сумму покупки и др..
Ему на смену пришел электронный терминал оплаты (POS-терминал), который упрощал взаимодействие с картой, т.к. передавал информацию о карте напрямую в процессиноговые центры платежной системы.

При приеме карты кассир должен был получить информацию от банка, что у держателя карты есть необходимый объем денежных средств для оплаты, в противном случае товар или услуга не могла быть оплачена.
Изначально этот процесс выглядел следующим образом: кассир звонил в банк-эквайер, тот связывался с банком-эмитентом, выпустившем карту, который подтверждал наличие необходимой суммы и инициировал ее передачу в банк-эквайер либо сообщал о невозможности оплаты.
Платежные системы изначально выступали каналом связи между банками.
Однако с увеличением количества карт создавалась высокая нагрузка на банки, и с целью ее снижения появились специальные процессинговые центры, которые совместно с платежными системами осуществляли функцию клиринга~\cite{habr_fondy_payment_history}.

Клиринг~-- это комплекс взаиморасчётов за оказанные услуги, проданные товары или ценные бумаги, основанные на безналичных расчётах.
Клиринг в платёжной системе~-- это взаиморасчёты по любым операциям, совершённым с помощью банковской карты.
Функцию клиринга выполняет ПС, за счет нее снижается нагрузка на банки, выступающие в роли эквайеров, т.к. ПС переводит им деньги в конце операционного дня~\cite{habr_nspk_cliring}.

Процесс идентификации голосом постепенно ускорялся, за счет повышения стабильности и качества телефонии.
Однако с ужесточением требованием ПС к времени подтверждения транзакции и развития банковских алгоритмов ему на смену пришла авторизация по пин-коду, которая является актуальной технологией на данный момент.
ПС совместно с банками продолжают развивать технологию авторизации, в результате чего сейчас для выполнения платежных операций, не превышающих определенный лимит, не требуется пин-код.

Также на текущий момент в России активно развивается оплата посредством QR-кодов, предоставляемых Системой Быстрых Платежей (СБП) и/или банками-эквайерами.
Данная технология не новая, однако оказалась востребованной среди пользователей, поскольку для оплаты по QR подойдет любое мобильное устройство с камерой и выходом в интернет. 
А после наложения на Россию санкций в 2022-м году смартфоны под управлением ОС IOS лишились возможности оплаты посредством NFC, и оплата по QR-коду стала единственно-возможным вариантом~\cite{habr_nspk_qr}.


\subsubsection{Развитие банковских карт}

Банковские карты так же, как и сами платежные операции, претерпели ряд изменений.
Сначала в них появилась магнитная полоса для быстрой идентификации карты платежным терминалам с помощью статических данных, хранимых в карте.
В 1993 году международные платёжные системы Mastercard, Visa и Europay подписали соглашение о совместной работе, чтобы развить технологии банковских карт.
В результате чего в 1994 году была выпущена первая версия стандарта EMV и систем на его основе.

Данный стандарт предусматривал наличие специального EMV-чипа, встроенного в карты.
Данный чип~--- это микропроцессор, предназначенный для безопасного хранения и обработки данных при проведении платежных операций.
В отличие от традиционной магнитной полосы, которая содержит статичные данные и легко подделывается, EMV-чип генерирует уникальный криптографический код для каждой транзакции, что делает её практически невозможной для подделки~\cite{emv_specifications_book}.

EMV-стандарт был внедрен с целью глобального повышения безопасности безналичных платежей и снижения уровня подделки карт и кражи их данных.
EMV-стандарт ввел понятие офлайн транзакции~-- платежной операции исключительно с участием карты и платежного терминала, которые проводит ее офлайн аутентификацию.
В онлайн транзакции терминал связывается в режиме реального времени с банком-эквайером, который через ПС запрашивает аутентификацию карты у банка-эмитента.

После массового внедрения EMV-карт во многих странах наблюдалось значительное снижение случаев фрода с использованием поддельных карт~\cite{plas_emv_fraud}.
Фрод~-- это проведение мошеннических (неправомерных) операций с использованием банковских карт.
Кроме того, EMV-чип лег в основу технологий бесконтактной оплаты, таких как PayPass (Mastercard), payWave (Visa) и Mir Accept (НСПК), где также используется принцип одноразовых криптограмм.
Бесконтактные карты используют технологию радичастотной модуляции сигнала (RFID), с использованием антенны, встроенной в карту, представленной на рисунке~\ref{fig:emv_card}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.4\textwidth]{images/research/emv_card}
    \caption{\centering Структура бесконтактной EMV-карты}
    \label{fig:emv_card}
\end{figure}

С распространением технологии NFC появилась сфера мобильных платежей.
Покупатели получили возможность быстро и безопасно выполнять оплату посредством устройств с поддержкой NFC с помощью виртуальных карт, добавленных в приложение «цифрового кошелька».
Примеры подобных приложений: Apple Pay, Google Pay, Mir Pay и др..


\subsection{Анализ процесса платежа через терминал}

\subsubsection{Оплата бесконтактной картой}
\label{subsubsec:contactless_payment}

Процесс оплаты с использованием бесконтактной банковской карты может протекать несколькими различными способами.
Как уже было упомянуто ранее, есть онлайн и офлайн оплата через терминал.
Первая происходит с запросом подтверждения банком-эквайера от банка-эмитента в реальном времени.
Вторая происходит исключительно без моментального подтверждения банком, с участием карты и платежного терминала, который проводит ее аутентификацию.
Также для оплаты могут использоваться разные типы карт.
Однако именно бесконтактную оплату поддерживается только картами, соответствующими стандарту EMV.

При этом карта в защищенной области памяти хранит общий с эмитентом ключ MK-AC (Application Cryptogram Master Key).
Во время совершения оплаты при онлайн-операции карта генерирует на основе MK-AC сессионный ключ SK-AC (Application Cryptogram Session Key) и использует его, данные карты и данные об операции, полученные с терминала, для генерации криптограммы операции ARQC (Authorization Request Cryptogram).
В основе генерации криптограммы лежит алгоритм 3DES (Triple DES).
В общем случае данные по операции поступают от карты к платежному терминалу, далее на хост банка-эквайера, затем к платежной системе и на самом последнем этапе к банку-эмитенту для авторизации.
Результат авторизации передается назад на платежный терминал и карту.
Данный процесс изображен на рисунке~\ref{fig:emv_card_payment}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_card_payment}
    \caption{\centering Процесс оплаты посредством EMV-карты}
    \label{fig:emv_card_payment}
\end{figure}

Банк-эмитент проверяет пришедшую криптограмму операции, путем ее сравнения со значением, которое генерирует сам на основе данных об операции, пришедших вместе с ARQC.
Банк-эмитент может одобрить или отклонить операцию по результатам анализа данных карты, криптограммы, установленных лимитов операций, рисков, а также других параметров~\cite{habr_nspk_mir_payment}.

Далее банк-эмитент на основе динамических данных транзакции генерирует ARPC (Authorisation Response Cryptogram) и отправляет эту криптограмму карте.
В тот момент, когда карта подтвердит пришедший ARPC, взаимная аутентификация карты и эмитента – выполнена~\cite{emv_card_mechanism}.


\subsubsection{Оплата мобильным приложением-кошельком}

При оплате мобильным кошельком выданная банком-эмитентом карта непосредственного участия в оплате не принимает.
Держатель карты вносит данные карты в цифровой кошелек, после чего карта «добавляется» в приложение, точнее не она, а специальный токен-профайл, сгенерированный на базе этой карты.
При этом карточные данные и ключ эмитента MK-AC, хранимый на карте, на телефон не передаются, поэтому оплата посредством приложения происходит с использованием токен-профайла и его специальных ключей.

Процесс добавления карты в приложение-кошелек представлен на рисунке~\ref{fig:add_mob_cardholder}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/add_mob_cardholder}
    \caption{\centering Процесс оплаты посредством мобильного приложения-кошелька}
    \label{fig:add_mob_cardholder}
\end{figure}

Цифрами на рисунке~\ref{fig:add_mob_cardholder} обозначены следующие этапы добавления карты в кошелек:

\begin{enumerate}
    \item держатель карты вводит данные в приложение;
    \item приложение передает их в зашифрованном виде через поставщика услуг мобильного кошелька(WSP~-- Wallet Service Provider) в платежную систему (в случае приложения Mir Pay поставщиком услуг кошелька является НСПК~-- Национальная система платежных карт~-- поэтому данные сразу попадают в ПС);
    \item платформа мобильных платежей (ПМП) производит обработку данных: расшифровывает их, по номеру карты определяет, каким эмитентом она была выдана, и запрашивает у него подтверждение на возможность добавления карты в кошелек;
    \item банк-эмитент возвращает подтверждение или запрет на возможность добавления карты в кошелек;
    \item в случае получения подтверждения для данной карты происходит процедура генерации токен-профайла;
    \item передачи токен-профайла в мобильное приложение пользователя;
    \item мобильное приложение запрашивает у ПМП несколько одноразовых ключей, которые будут использоваться приложением при совершении покупки в качестве сессионных ключей для проведения операции, аналогичных SK-AC.
\end{enumerate}

Таким образом, вместо карточных данных на мобильном устройстве будет храниться токен-профайл, который привязан к конкретным карте и устройству.
Преобразование токен-профайла в исходные данные карты вне платформы мобильных платежей является невозможным.
Одноразовые ключи не могут быть применены более одного раза, поэтому в процессе использования мобильное приложение с некоторой периодичностью подгружает из ПМП новые ключи.


Стоит отметить, что в Mir Pay используется схема, при которой происходит хранение нескольких одноразовых ключей, но существует и другой подход, при котором происходит хранение одного ключа на устройстве.
Такой подход требует наличия аппаратного элементов безопасности (АЭБ) на устройстве, например TEE (Trusted Execution Environment) или SE (Secure Element), и некоторые кошельки применяют именного этот подход, однако он накладывает ограничение в виде наличия АЭБ в устройстве.
Mir Pay также использует АЭБ при его наличии, но уже для хранения одноразовых ключей.

Высокая степень безопасности при использовании приложения гарантируется тем, что для обмена конфиденциальными данными ПМП и Mir Pay генерируют ключевые пары и обмениваются лишь публичными компонентами.
При этом хранением разных ключевых компонент происходит в разных системных хранилищах: как в ключевом хранилище, так и в оперативной памяти.
Для совершения мошеннической операции придется извлечь и расшифровать криптограммы всех ключей, а это неэффективно, в силу того, что для проведения операций используются строго одноразовые ключи.
Передача конфиденциальных данных, например токен-профайла, одноразовых ключей для проведения операций и данных по уже совершенным операциям, начинается только после того, как Mir Pay и ПМП обменялись публичными ключами, создав защищенный канал, и происходит только с использованием <<крипто-стойких>> алгоритмов~\cite{habr_nspk_mir_payment}.

Процесс оплаты с помощью приложения кошелька представлен на рисунке~\ref{fig:emv_mob_payment}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_mob_payment}
    \caption{\centering Процесс оплаты посредством мобильного приложения-кошелька}
    \label{fig:emv_mob_payment}
\end{figure}

При оплате с помощью мобильного приложения-кошелька используются данные токен-профайла, а криптограмма ARQC генерируется на основе одного из одноразовых ключей (вместо SK-AC как при оплате картой).
Также при оплате приложением может использовать алгоритм шифрования, отличный от 3DES.
В частности в Mir Pay для генерации криптограммы используется более современный симметричный алгоритм блочного шифрования AES (Advanced Encryption Standard).

После генерации ARQC данные об операции так же, как и при оплате банковской картой, проходят через терминал и хост банка-эквайера, попадая в платежную систему.
По наличию токена и его номеру (из токен-профайла) платежная система определяет, что производится полата с помощью мобильного приложения, и направляет данные операции в ПМП для проверки криптограммы и детокенизации~-- превращения токена в данные соответствующей банковской карты.
Данные операции вместе с данными карты отправляются для авторизации в банк-эмитент.
После чего на основе ответа банка-эмитента запускается процесс обратного преобразования платежных данных.

Отличие от оплаты картой как раз в том, что криптограмма проверяется не эмитентом, а ПМП, так как одноразовые ключи и токен-профайл генерируются именно в в платформе мобильных платежей~\cite{habr_nspk_mir_payment}.


\subsection{Анализ платежных технологий}

В предыдущем подразделе были рассмотрены стандартные сценарии выполнения платежных операций.
Отдельное внимание хочется уделить процессам взаимодействия платежного терминала с банковской картой или мобильным платежным приложением и с хостом банка-эквайера с целью детального анализа происходящих процессов и используемых в них технологий.

Наиболее важным в данном контексте является стандарт EMV, т.к. он описывает характеристики банковских карт и других средств бесконтактной оплаты, а также весь процесс формирования платежа.

\subsubsection{Стандарт EMV}

EMV~--- стандарт для банковских карт, совместно разработанный платежными системами Europay, Mastercard и Visa.
Он используется  международными платежными системами (МПС) для проведения операций по банковским картам.

Повышенный уровень безопасности карт стандарта EMV обусловлен наличием встроенного чипа, который называется Secure Element.
Чип хранит данные в зашифрованном формате, а также может запускать приложения на карте и обмениваться командами с кассовыми терминалами.

Банковская карта с поддержкой стандарта EMV, является стандартной смарт-картой, однако, имеет расширенный функционал.
Технология функционирования платежной карты (как контактной, так и бесконтактной) и взаимодействия платежного терминала с ней описана в стандарте ISO/IEC 7816 и в <<EMV Integrated Circuit Card Specifications for Payment Systems>>.
Технология работы с бесконтактной картой описана в стандарте ISO/IEC 14443, а также в <<EMV Contactless Specifications for Payment Systems>>.
Карта имеет операционную систему со встроенной файловой системой и приложениями, причем предназначенными не только для реализации платежей~\cite{emv_specifications_book}.


\paragraph{EMV-карта}

Главное новшество EMV-карт~--- возможность проверки динамической криптограммы карты (цифровой подписи ее статических данных).
Для карт с магнитной полосой терминалы не имели такую возможность и выполняли проверку только статических данных карты, в результате чего такие карты легко копировались.
Процесс аутентификации карты с магнитной полосой и EMV-карты представлен на рисунках~\ref{fig:magnetic_card_auth} и~\ref{fig:emv_card_auth} соответственно.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/magnetic_card_auth}
    \caption{\centering Аутентификации карты с магнитной полосой в ходе платежной транзакции}
    \label{fig:magnetic_card_auth}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_card_auth}
    \caption{\centering Аутентификации EMV-карты на основе динамической криптограммы в ходе платежной транзакции}
    \label{fig:emv_card_auth}
\end{figure}

Динамическая аутентификация карты в ходе EMV-транзакции происходит по следующему алгоритму:

\begin{enumerate}
    \item терминал передает данных о транзакции на карту (сумма, валюта, страна и пр.);
    \item происходит проверки рисков транзакции как картой, так и терминалом;
    \item если проверка не пройдена на карте, то процесс прерывается, если пройдена~-- карта подписывает данные транзакции;
    \item терминал помечает полученными от карты данные тегом <<DE 55>> (стандарт ISO 8583) и отправляет вместе с прочими в банк-эквайер;
    \item банк-эмитент выполняет проверку динамической подписи транзакции.
\end{enumerate}

Данные в Field/DE 55 содержится важная информация для оценки рисков транзакции  эмитентом и ПС, в частности Terminal Verification Result и Card Verification Result~\cite{emv_card_mechanism}.

Банк-эмитент также может выслать свою криптограмму карте для дополнительной аутентификации или обновить данные карты (например, лимит карты), записанные на чипе карты (уже после успешной аутентификации)~\cite{emv_book_2}.
Более подробно процесс формирования и проверки криптограммы уже был описан в пункте~\ref{subsubsec:contactless_payment}.


\paragraph{Платежные EMV-приложения}

Платежное EMV-приложение выступает в качестве интерфейса для взаимодействия с картой.
С помощью серии команд, поданных в приложение на карте осуществляется управление приложением и состоянием транзакции.

Для работы с приложениями на карте используются APDU-команды, описанные в стандарте ISO/IEC 7816--4, рассматриваемым в пункте~\ref{subsubsec:7816}.
С их помощью реализуется функционал приложения, например, создание банковской транзакции и управление ее состоянием.
Стоит также отметить, что производители карты реализуют свои собственные приложения для оплаты, реализуя при этом стандарт выполнения платежа в EMV, который называется EMV Transaction Flow, о нем речь пойдет в подпункте~\ref{par:emv_transaction}.

Каждое приложение имеет свой собственный идентификатор~--- AID (Application Identifier).
Он указывает к какому типу ПС относится приложение и для каких карт может использоваться (для карт одной ПС, могут использоваться разные приложения).
На основе идентификатора приложения AID терминал определяет возможность проведения транзакции или, в случае нескольких приложений, составляет список поддерживаемых приложений и предлагает выбрать одно из них для выполнение транзакции~\cite{emv_card_mechanism}.


\paragraph{Безопасность EMV-карты}

Любые смарт-карты, и EMV-карты не исключение, имеют механизм разграничения доступа, с помощью которого происходит контроль состояния карты в рамках текущей сессии подключения и механизм проверки условий доступа, другими словами, проверка прав на работу с файлами.
Наличие прав зависит от состояния карты в рамках текущей сессии, которое может изменяться вводом определенных предварительно заложенных кодов доступа~\cite{habr_smart_card_for_little}.

Также смарт-карты имеют встроенные механизмы для шифрования, однако их аппаратная реализация отличается в зависимости от производителя.
В EMV-чипах реализованы следующие алгоритмы шифрования:

\begin{itemize}
    \item RSA (асимметричное шифрование): применяется в EMV-картах для аутентификации и защиты данных, используется для динамической аутентификации (DDA) и комбинированной аутентификации (CDA), обеспечивая высокий уровень безопасности за счет генерации уникальных ключей для каждой транзакции;
    \item DES и 3DES (симметричное шифрование): DES - устаревший и менее безопасный стандарт, однако по-прежнему применяемый в некоторых системах, более распространенным является 3DES (Triple DES), который обеспечивает улучшенную безопасность за счет применения алгоритма DES трижды, эти алгоритмы используются для шифрования PIN-кодов;% TODO добавить ссылку на раздел про DES
    \item AES (Advanced Encryption Standard): современный симметричный алгоритм шифрования, предлагающий более высокий уровень безопасности по сравнению с DES и 3DES, благодаря более длинным ключам и более сложным методам шифрования, используется в технологии HCE (Host Card Emulation) для шифрования в приложениях <<Цифровых кошельках>> на мобильных устройствах;
    \item SHA-1 и SHA-256 (хэширование): используется для создания хэш-значений транзакций, из-за уязвимостей SHA-1 многие системы переходят на SHA-256, который обеспечивает более высокий уровень безопасности, с помощью хэш-функции гарантируется целостность данных в процессе транзакций~\cite{emv_fastercapital}.
\end{itemize}

Важно понимать, что персональная информация владельца карты в платежных приложениях не хранится, а сами приложения, ключи и некоторые PIN-коды, защищены от прямого доступа и модификации.
Однако, информация, не относящаяся к конфиденциальным данным, является доступной.
К подобной информации относятся различные данные, необходимые для выполнения платежных операций, в частности сертификаты ключей-доступа, номер карты (PAN), списки методов проверки карты (CVM~-- Card Verification Methods list) и другая информация.
Примерный перечень всех доступных для чтения данных приложения приведен на рисунке~\ref{fig:emv_available_data}.
Доступные данные организованы в записи (рекорды или треки), которые можно получить с помощью команд «Get Processing Options» и «Read Record», описанных  в ISO/IEC 7816.
Дополнительно данные технических настроек, таких как лимиты и счетчики, могут быть доступны через команду «Get Data» с указанием требуемого типа~\cite{emv_card_mechanism}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_available_data}
    \caption{\centering Доступные данные платежного EMV-приложения}
    \label{fig:emv_available_data}
\end{figure}

Банковская платежная карта имеет несколько уровней защиты, определенных хронологией ее создания:

\begin{enumerate}
    \item производитель чипа карты задает некий первичный ключ для доступа к прошивке карты, с помощью него можно установить ОС;
    \item ОС карты также имеет свой ключ, который необходим для работы с файлами и приложениями на карте, с помощью него можно установить платежные приложения;
    \item платежные приложения на карте персонализируются с помощью определенных параметров и ключей приложения, заложенных банком-эмитентом с целью обеспечения безопасности EMV-транзакций.
\end{enumerate}

После чего, как правило, изменение работы карты и приложения становится практически невозможным без знания ключей.
Данные платежного приложения могут модифицироваться после выпуска карты посредством банкомата или терминала, которые после успешной аутентификации карты в ходе банковской транзакции, передает скриптовую командой, имеющую цифровую MAC-подписью, гарантирующей целостность данных.
Такая возможность предусмотрена для того, чтобы  банк-эмитент управлять блокировкой карты, обновлять лимиты или настройки.
В данном случае, MAC (Message Authentication Code)~--- это аналог цифровой подписи, который гарантирует целостность данных, переданных на карту.
Для его расчета используется соответствующий ключ приложения (один из 3-х DES ключей загружаемых в приложение).
% TODO добавить раздел про DES и ссылку на него

Технически возможно перенести данные с одной банковской карты на другую, если приложение на новой карте не персонализировано.
Однако отсутствие возможности доступа, а, как следствие, и копирования ключей делает карту неприменимой для проведения транзакций, т.к. без них приложение не сможет сгенерировать корректную подпись транзакции, что приведет к отклонению операции банком-эмитентом.
Кроме того, невозможность выполнить CDA (Combined Data Authentication) или DDA (Dynamic Data Authentication) существенно ограничивает использование копии.
Единственным уязвимым местом может быть SDA (Static Data Authentication), однако этот метод уже считается устаревшим и редко используется как единственный механизм аутентификации~\cite{emv_card_mechanism}.


\paragraph{EMV-транзакция}
\label{par:emv_transaction}

В пункте~\ref{subsubsec:contactless_payment} уже упоминалось о существовании 2-х типов платежный транзакций: онлайн и офлайн, а также в общих чертах было рассмотрено выполнение онлайн транзакции.
Есть также 2 способа аутентификации: офлайн или Static Data Authentication (SDA) и онлайн или Dynamic Data Authentication (DDA).
Онлайн аутентификация проводится при непосредственном участии эмитента.
Офлайн-аутентификация, в свою очередь, выполняется самим платежным терминалом.
Важно отметить, что при обработке онлайн-операции могут одновременно использоваться как онлайн, так и офлайн аутентификация, если карта и терминал поддерживают оба метода, такой вид аутентификации называется Combined Data Authentication (CDA).

Любая платежная транзакция в соответствии со стандартом EMV начинается с выбора платежного приложения на терминале.
После выбора приложения терминал и карта выполняют ряд функций, которые схематично представлены на рисунке~\ref{fig:transaction_flow_example} в порядке своего выполнения.
Для каждой функции есть условия и ограничения применения, которые детально описываются стандартом.
В соответствии с EMV стандартом терминал во время транзакции должен выполнять только те функции, которые поддерживаются конкретной платежной картой~\cite{emv_book_3}.


\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/transaction_flow_example}
    \caption{\centering Схема алгоритма выполнения транзакции терминалом}
    \label{fig:transaction_flow_example}
\end{figure}

За безопасность проведения транзакции отвечают следующие этапы:

\begin{itemize}
    \item аутентификация (офлайн, онлайн или комбинированная);
    \item оценка рисков проведения транзакции;
    \item верификация держателя карты на основе онлайн и/или офлайн PIN-кода, размера суммы транзакции, страны, валюты и прочих данных;
\end{itemize}

% TODO: заменить на корректное что-то, что меньше подпункта
\paragraphit{Онлайн аутентификация}

Процесс выполнения онлайн аутентификации представлен на рисунке~\ref{fig:online_auth}.
Его описание было приведено в пункте~\ref{subsubsec:contactless_payment}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/online_auth}
    \caption{\centering Процесс выполнения онлайн аутентификации}
    \label{fig:online_auth}
\end{figure}


% TODO: заменить на корректное что-то, что меньше подпункта
\paragraphit{Офлайн аутентификация}

Как уже отмечалось ранее офлайн аутентификация происходит без непосредственного взаимодействия с банком или ПС в момент совершения операции.
Карта и терминал могут самостоятельно одобрить транзакцию, если её сумма не превышает установленный лимит.
Терминал же передает информацию в банк в соответствии с установленным режимом.
Преимущества данного подхода в том, что держатель карты может завершить оплату при отсутствии связи с банком, и операции на небольшие суммы выполняются значительно быстрее.

Офлайн аутентификация происходит с использованием асимметричной криптографии RSA.
Основная причина использования RSA заключается в распределении ключей: в онлайн-транзакциях ключи известны только карте и банку, тогда как в офлайн-процессе терминал также должен иметь доступ к ключу.
С учетом большого количества терминалов, повышается вероятность компрометации секретного ключа, что делает асимметричный подход более безопасным, т.к. терминал хранит только открытый ключ, а карта - секретный ключ.

Упрощенная модель статической аутентификации (Static Data Authentication) представлена на рисунке~\ref{fig:sda}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/sda}
    \caption{\centering Упрощенная модель Static Data Authentication (SDA)}
    \label{fig:sda}
\end{figure}

Центральную роль в этом процессе играет ПС, выступающая в качестве сертификационного центра, она создает пару ключей: секретный (красный) и открытый (синий).
Аналогичную пару ключей генерирует банк-эмитент.
Публичный ключ эмитента включается в специальный сертификат (Issuer Public Key Certificate), подписанный с использованием приватного ключа ПС.
Данный сертификат загружается на карту в процессе ее персонализации.

Когда платежный терминал подключается к торговой точке, в него загружается публичный ключ ПС через банк-эквайер.

Во время выполнения офлайн транзакции терминал осуществляет аутентификацию карты по следующему алгоритму:

\begin{enumerate}
    \item терминал считывает сертификат банка-эмитента (Issuer Public Key Certificate) с карты и с помощью публичного ключа ПС проверяет его подпись;
    \item если подпись сертификата подтверждена, терминал извлекает публичный ключ банка-эмитента из сертификата;
    \item данный ключ используется для проверки подписи критически важных данных карты, что позволяет удостовериться в её подлинности.
\end{enumerate}

Описание выполнение SDA из стандарта EMV приведено на рисунке~\ref{fig:emv_offline_sda}~\cite{emv_book_2}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_offline_sda}
    \caption{\centering Диаграмма Static Data Authentication (SDA)}
    \label{fig:emv_offline_sda}
\end{figure}

SDA в настоящее время уступает место более современным технологиям DDA (Dynamic Data Authentication) и CDA (Combined Data Authentication).
Эти методы включают в себя SDA, но также используют динамическое подписание данных, передаваемых между терминалом и картой.

Технология SDA позволяет удостовериться в неизменности данных на карте, но не обеспечивает полной защиты от копирования.
В отличие от неё, DDA и CDA подтверждают подлинность карты, поскольку карта хранит уникальный приватный ключ.
Сертификат этого ключа подписан приватным ключом эмитента, а сертификат эмитента~-- приватным ключом платежной системы.

DDA и CDA схожи по структуре: оба используют уникальный ключ карты и динамические данные.
Однако DDA выполняется как отдельная операция до начала основной транзакции, тогда как CDA интегрирована в транзакционный процесс и дополнительно подписывает криптограмму карты.
Несмотря на то, что CDA обеспечивает более высокий уровень безопасности, на практике чаще применяется DDA.

Описание выполнение офлайн DDA и CDA из стандарта EMV приведено на рисунке~\ref{fig:emv_offline_dda_cda}~\cite{emv_book_2}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_offline_dda_cda}
    \caption{\centering Диаграмма офлайн DDA и CDA}
    \label{fig:emv_offline_dda_cda}
\end{figure}

Также существует алгоритм офлайн DDA с использованием криптографии эллиптических кривых (Elliptic Curve Cryptography~-- ECC), который называется
Extended Data Authentication (XDA).

Описание выполнение офлайн XDA стандарта EMV приведено на рисунке~\ref{fig:emv_offline_xda}~\cite{emv_book_2}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/research/emv_offline_xda}
    \caption{\centering Диаграмма офлайн XDA}
    \label{fig:emv_offline_xda}
\end{figure}


При выполнении XDA карта генерирует цифровую подпись, которая проверяется терминалом.
Эта подпись аутентифицирует карту и подтверждает подлинность кода аутентификации приложения (Application Cryptogram, AC), а также других критически важных данных, переданных картой и терминалом.
Это делает невозможным создание поддельной карты и обеспечивает целостность данных между картой и терминалом.

Для реализации XDA необходимо наличие центрального удостоверяющего центра (Certification Authority)~--- высоко защищённого криптографического устройства, которое подписывает открытые ключи эмитента.
Если приложение терминала поддерживает XDA, то оно должно содержать соответствующие открытые ключи удостоверяющего центра для данного приложения.

\paragraph{Проверки безопасности транзакции}

Карты и терминалы также оценивают риски транзакций.
Для офлайн транзакций карта использует счетчики операций, лимиты сумм, правила проверки PIN-кода, а также другие параметры.
Эмитент может ограничивать количество последовательных офлайн операций или их максимальную сумму, устанавливая уровень риска.

Каждая платежная система имеет собственный набор правил для принятия решений о проведении транзакции в офлайн или онлайн режиме либо её отклонении.
Эти правила, настраиваемые эмитентом, учитывают результаты предыдущих операций, показатели счетчиков и лимитов, а также результаты проверки PIN-кода~\cite{secure_nfc_mc}.


В технологии EMV также применяются методы проверки держателя карты (Cardholder Verification Method, CVM).
Они сохранили основные подходы, используемые ранее в магнитных картах.
Наиболее распространены проверка PIN-кода (онлайн или офлайн) и подписи владельца карты.
Однако не все платежные терминалы поддерживают одинаковые методы проверки из-за различий в оборудовании или ограничений конкретных EMV-приложений.

Для выбора подходящего метода используются CVM списки, которые содержат перечень методов проверки и их приоритеты.
Каждый терминал и карта имеют собственные списки, которые объединяются для формирования итогового перечня.
На его основе терминал выбирает метод с наивысшим приоритетом, поддерживаемый обеими сторонами, и осуществляет проверку.
Срабатывают только те методы проверки, которые совпадают в списках карты и терминала (происходит проверка пересечений CVM-листов).
Если методы не совпадают, то проверка данным методом не выполняется, если это возможно, если невозможно - транзакция отклоняется~\cite{emv_card_mechanism, emv_book_3}.

Пример распространенного CVM-листа в формате шестнадцатеричного 8-байтного значения~--- <<4403410342031E031F02>>.
Его расшифровка представлена на рисунке~\ref{fig:cvm_check}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{images/research/cvm_check}
    \caption{\centering Расшифрока CVM списка}
    \label{fig:cvm_check}
\end{figure}

Данному примеру соответствует следующий алгоритм действий (при условии совпадения наличия методов):

\begin{enumerate}
    \item запрос PIN карты,
    \item если пользователь отказывается (а он имеет право отказаться)~--- запрос открытого офлайн-PIN,
    \item если снова отказывается~--- запрос онлайн-PIN, который проверяется не картой, а хостом,
    \item если снова отказался~--- запрос подписи (от ее ввода уже невозможно отказаться).
\end{enumerate}

Если в CVM-листе терминала не указан метод <<проверка по подписи>>~--- тогда он пропускается, и это не приравнивается к отказу выполнения транзакции, потому что в таком случае используется метод <<No CVM>> с условием «If not unattended cash and not manual cash and not purchase».
Если и этого метода в CVM-листе терминала нет~--– то проверка неудачная и транзакция отклоняется~\cite{habr_cvm}.


\subsubsection{Стандарт ISO/IEC 14443}

ISO/IEC 14443 - это международный стандарт, описывающий требования к технологиям бесконтактной идентификации, используемой в смарт-картах и
RFID-устройствах. 
Этот стандарт охватывает физические характеристики карт, протоколы передачи данных и методы антиколлизии~\cite{iso_14443}.
Основное применение данный стандарт нашел в сфере бесконтактных платежей посредством банковских карт.
Помимо этого он используется в электронных проездных, а также удостоверениях личности и электронных паспортах.

Обмен информации основан на принципе индуктивной связи между антенной модуля и антенной карты.
Под антенной понимается замкнутая металлическая катушка, способная принимать и излучать электромагнитные волны.
Дальность взаимодействия бесконтактной связи составляет до 10 см, а скорость передачи данных варьируются в диапазон от 106 до 848 кбит/с.

ISO 14443 разделяется на четыре части:

\begin{enumerate}
    \item физические характеристики: содержит описание размеров, материалов и формы карт (обычно формата ID-1, аналогичного банковским картам);
    \item радиоинтерфейс: определяет электромагнитные параметры, включая метод модуляции и демодуляции сигнала;
    \item инициализация и методы антиколлизии: описывает, как карты идентифицируются, и как модуль выбирает конкретную карту из множества доступных (например, в очереди пользователей);
    \item протокол обмена данными: устанавливает правила взаимодействия между картой и модулем, включая форматы команд и структуру данных, содержит описание Half-duplex block transmission protocol~--- протокола, разработанного в соответствии с принципом многоуровневости модели OSI, предназначенного для минимизации взаимодействия карты и модуля, описывая правила между границами уровней данной модели и количества уровней~\cite{iso_14443_en}.
\end{enumerate}


На данный момент существует 2 версии данного стандарта: A и B.
Изначально был разработан стандарт А, однако он обладал недостатками в виде ограниченной производительности и совместимости.
Версия B была разработана позже с целью их исправления.
Устройство на базе версии B данного стандарта обладает большей технической сложностью, а его стоимость выше, чем у устройств ана базе версии A.
Поэтому наиболее широкое применение по-прежнему остается за стандартом A.
Именно он используется в сфере банковских платежей с помощью бесконтактных карт.
Тип B чаще используется в более сложных системах, где необходимо передавать больший объем данных, и имеется больше требований безопасности.
Примерами таких систем выступают:

\begin{itemize}
    \item электронные паспорта (ePassports),
    \item удостоверения личности,
    \item медицинские карты.
\end{itemize}

Основные отличия технологий A и B приведены в таблице~\ref{tab:iso14443_comparison}.

\begin{table}[H]
    \caption{Сравнительная характеристика стандартов ISO 14443-A и ISO 14443-B}
    \label{tab:iso14443_comparison}
    \begin{sloppypar}
        \centering
        \begin{tabularx}{\textwidth}{ | >{\raggedright\arraybackslash}X | >{\raggedright\arraybackslash}X | >{\raggedright\arraybackslash}X | }
            \hline
            \textbf{Характеристика} & \textbf{ISO 14443-A} & \textbf{ISO 14443-B} \\
            \hline
            Метод модуляции & Amplitude Shift Keying (ASK) & Binary Phase Shift Keying (BPSK) \\
            \hline
            Скорость передачи & 106 кбит/с & 106, 212, 424, 848 кбит/с \\
            \hline
            Антиколлизия & Использует метод <<первый пришёл>> & Использует временные слоты и уникальные идентификаторы \\
            \hline
            Стабильность питания & Низкая & Высокая \\
            \hline
            Устойчивость к помехам & Высокая защита от помех & Уязвимость к внешним воздействиям \\
            \hline
        \end{tabularx}
    \end{sloppypar}
\end{table}


\paragraph{ISO/IEC 14443--3}

ISO/IEC 14443--3 описывает третий уровень стандарта ISO/IEC 14443, который фокусируется на установлении связи между устройствами считывания (PCD - Proximity Coupling Device) и бесконтактными картами (PICC - Proximity Integrated Circuit Card).
Данный уровень определяет механизмы обнаружения карт, установления связи и антиколлизии.
Этот уровень является критически важным для правильной работы систем, где одновременно могут находиться несколько карт в зоне действия ридера~\cite{iso14443-3}.

Антиколлизия (anti-collision) в контексте стандарта ISO/IEC 14443-3~--- это механизм, позволяющий устройству чтения (PCD) корректно идентифицировать и взаимодействовать только c одной картой (PICC) в случае, когда несколько бесконтактных карт находятся в зоне действия считывателя.

Стандарт ISO/IEC 14443--3 описывает следующие аспекты взаимодействия PCD и PICC:

\begin{itemize}
    \item процесс обнаружения карт (Polling): обнаружение карт PCD, которые входят в поле его действия;
    \item формат байтов, кадры и временные характеристики: правила формирования кадров данных и временные интервалы передачи, которые должны соблюдаться для корректной передачи информации между устройствами;
    \item антиколлизионные методы: способы обнаружения и выбора одной карты из нескольких, находящихся в зоне действия ридера;
    \item инициализация связи: начальная команда запроса, корректный ответ на запрос и ошибки соединения, а также параметры, необходимые для начала взаимодействия между PCD и PICC.
\end{itemize}

В соответствии со стандартом определена диаграмма состояний бесконтактной карты, представленная на рисунке~\ref{fig:picc_states}, она является конечным автоматом.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{images/research/picc_states}
    \caption{\centering Диаграмма состояний бесконтактой карты с интегральной схемой}
    \label{fig:picc_states}
\end{figure}

Как видно из рисунка~\ref{fig:picc_states}, бесконтактная карта с интегральной схемой имеет несколько основных состояний:

\begin{itemize}
    \item Power OFF: состояние выключения,
    \item IDLE и HALT: состояния ожидания, которым свойственно низкое потребление электроэнергии,
    \item READY и READY*: состояния готовности к работе,
    \item ACTIVE и ACTIVE*: основные рабочие состояния, в которых доступен функционал, описанный в ISO 14443--4.
\end{itemize}

Также в соответствии со стандартом определен алгоритм работы устройства PCD, который представлен на рисунке~\ref{fig:pcd_flow}.
На нем изображена последовательность работы устройства считывания.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{images/research/pcd_flow}
    \caption{\centering Алгоритм работы устройства-считывателя}
    \label{fig:pcd_flow}
\end{figure}


На рисунках~\ref{fig:picc_states} и~\ref{fig:pcd_flow} приводятся следующие команды и процедуры, с помощью которых происходит взаимодействия PICC и PCD (приписка <<A>> обозначает, что данная команда предназначена для карт, взаимодействующих по стандарту ISO/IEC 14443-A):

\begin{itemize}
    \item REQA (Request A)~--- команда, отправляемая устройством считывания (PCD) для инициирования взаимодействия с картой (PICC), находящейся в состоянии <<IDLE>>, предназначена для проверки наличия карты в пределах досягаемости;
    \item WUPA (Wake-Up A)~--- команда для пробуждения карты из состояния <<HALT>>, используется, если карта находится в режиме ожидания и должна быть возвращена в активное состояние;
    \item AC (Anti-collision)~--- процедура антиколлизии, используемая для выбора одной карты из нескольких, находящихся в зоне действия устройства считывания, позволяет идентифицировать уникальный идентификатор карты (UID);
    \item nAC (Negative Anti-collision)~--- действие обратное процедуре антиколлизии, указывающее, что карта не была выбрана или произошла ошибка во время антиколлизионного процесса;
    \item SELECT~--- команда выбора карты, завершает процесс антиколлизии и устанавливает карту в активное состояние, после выполнения этой команды карта готова к обмену данными;
    \item nSELECT (Negative Select)~--- отрицательная команда выбора, применяемая при ошибке во время процесса выбора карты;
    \item HLTA (Halt A)~--- команда, переводящая карту в состояние <<HALT>>, в этом состоянии карта не отвечает на команды до получения команды WUPA;
    \item Error~--- состояние или ответ, возникающий в случае некорректного выполнения команды или нарушения последовательности команд;
    \item DESELECT~--- команда для завершения активного состояния карты, переводя её обратно в состояние <<IDLE>>;
    \item Enter ISO/IEC 14443--4~--- процесс, переводящий карту в следующий уровень протокола -- ISO/IEC 14443--4.
\end{itemize}


\paragraph{ISO/IEC 14443--4}

ISO/IEC 14443--4 описывает полудуплексный протокол передачи данных блочного типа (half-duplex block transmission protocol).
В данном стандарте определяются последовательности активации и деактивации протокола, а также обеспечивается взаимодействие с другими частями стандарта ISO/IEC 14443.

В данной части стандарта описана поддержка передачи блоков данных прикладного уровня (Application Protocol Data Units, APDUs), описанных в ISO/IEC 7816--4.
Что позволяет осуществлять сопоставление данных в формате APDU и использовать механизмы выбора приложений в соответствии с ISO/IEC 7816--5~\cite{iso_14443_en}.

В данной части протокола подробно описана активация PICC с помощью устройства PCD, схема активации приведена на рисунке~\ref{fig:pcd_flow_2_picc_activation}.


\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{images/research/pcd_flow_2_picc_activation}
    \caption{\centering Активация бесконтактной карты с помощью PCD}
    \label{fig:pcd_flow_2_picc_activation}
\end{figure}

Данный алгоритм в дополнение к действия, рассмотренным в ISO/IEC 14443--3, описывает действия, которые необходимо сделать для активации полудуплексного протокола передачи данных.
Важно отметить, что отправка RATS (Request for Answer To Select) на PCD в качестве следующей команды происходит после получения SAK, а также, что PICC отвечает на RATS~--- ATS (Answer To Select), это происходит только в том случае, если RATS получен непосредственно после выбора PICC.

Каждый бит RATS, ATS, PPS детально описан в 5 разделе ISO 14443--4~\cite{iso14443-4} Однако дополнительная информация также содержится в спецификации бесконтактного взаимодействия по стандарту EMV, в частности в разделе 10~\cite{emv_specifications_book}.

Half-duplex block transmission protocol~--- полудуплексный протокол передачи данных в виде блоков (кадров).
Он учитывает особые потребности внешнего окружения бесконтактных карт и использует определенный формат кадра, представленный на рисунке~\ref{fig:hd_block_format}.
Кадр состоит из поля пролога (обязательного), информационного поля (необязательного) и поля эпилога (обязательного).

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{images/research/hd_block_format}
    \caption{\centering Стандартный формат кадра Half-duplex block transmission protocol}
    \label{fig:hd_block_format}
\end{figure}

Каждый бит элементов данного кадра детально описан в 7 разделе ISO 14443--4~\cite{iso14443-4}.
Дополнительная информация, также содержится в спецификации стандарта EMV, в частности в разделе 10~\cite{emv_specifications_book}.


\subsubsection{ISO 7816}
\label{subsubsec:7816}

ISO/IEC 7816~--- это международный стандарт, который регулирует использование интегрированных схем (ИС) в картах, известных как смарт-карты.
Он охватывает различные аспекты смарт-карт, включая их физические характеристики, электрические интерфейсы, протоколы передачи данных и др..
Стандарт состоит из 15 частей, каждая из которых фокусируется на каком-либо аспекте~\cite{7816_wiki}.

Основное преимущество стандарта ISO/IEC 7816~--- способность обеспечивать совместимость между продуктами различных производителей.
Это достигается благодаря четким спецификациям, которые позволяют разработчикам создавать устройства и приложения, совместимые с картами, соответствующими этому стандарту.

\paragraph{APDU}

APDU (Application Protocol Data Unit)~--- это формат команд и ответов, используемый для взаимодействия между считывателями карт, например, платежными терминалами, и смарт-картами, в том числе банковскими картами с поддержкой технологии EMV.
Команды данного формата определены в стандарте ISO/IEC 7816 и разделены на два типа:

\begin{itemize}
    \item Command APDU~--- команда от терминала к карте;
    \item Response APDU~--- ответ от карты терминалу.
\end{itemize}


APDU-команды используются для передачи инструкций, таких как выбор приложения, запрос информации о карте, выполнение транзакций, чтение данных, а также запись информации на карту.
Важно отметить, что за счет APDU протокол ISO/IEC 7816 позволяет взаимодействовать с контактными картами как и с бесконтактными, посредством использования определенных команд.
Такая гибкость использования стандарта достигается за счет абстрагирования над другими протоколами взаимодействия, упомянутых в предыдущих разделах.

Команда APDU состоит из двух основных компонентов: заголовок и данные.
Более детальная структура представлена на рисунке~\ref{fig:apdu_com}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{images/research/apdu_com}
    \caption{\centering Структура APDU команды}
    \label{fig:apdu_com}
\end{figure}


APDU команда (APDU Command) разделяется на следующие элементы~\cite{medium_apdu2}:

\begin{itemize}
    \item CLA (Class): класс инструкции, определяет класс команды и используется для указания типа команды, которую карта должна выполнить;
    \item INS (Instruction): тип инструкции (например, SELECT, READ RECORD), определяет конкретную команду, которую должна выполнить карта;
    \item P1 и P2: параметры для команды (например, указание файла, записи), предоставляют дополнительную информацию или данные для адресации внутри карты;
    \item Lc: длина поля данных команды, если данные присутствуют (необязательный элемент);
    \item  Data (если применимо для команды): данные, специфичные для команды, которые необходимо отправить на карту (например, идентификатор приложения);
    \item Le: ожидаемая длина ответа от карты (необязательный элемент).
\end{itemize}


Структура APDU ответа (APDU Response) представлена на рисунке~\ref{fig:apdu_resp}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{images/research/apdu_resp}
    \caption{\centering Структура APDU ответа}
    \label{fig:apdu_resp}
\end{figure}

В состав APDU ответа входят следующие элементы:

\begin{itemize}
    \item Data: данные, отправленные картой в ответ на команду;
    \item SW1 и SW2 (Status Words): двухбайтовые коды статуса, указывающий результат выполнения команды.
\end{itemize}

Наиболее распространенными ответами являются <<90:00>>, означающий успешное выполнение, и <<6A:82>>~-- ошибка поиска файла или приложения~\cite{apdu_resp}.


\paragraph{Прикладное применение APDU}

Для инициализации транзакции между картой и терминалом, обмена данными и завершения процесса необходимо следовать определенной последовательности APDU команд.

Cписок стандартных APDU команд ISO 7816--4, в т.ч. используемых в стандарте EMV, приведен на рисунке~\ref{fig:apdu_commands}~\cite{iso7816-4}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{images/research/apdu_commands}
    \caption{\centering Список APDU команд, используемых при взаимодействии карты и терминала}
    \label{fig:apdu_commands}
\end{figure}

APDU-команды могут быть использованы для выбора приложения на банковской карте и для последующей работы с ним.
Есть приложения, в т.ч. платежные, которые способны взаимодействовать с данными в памяти карты.
С их помощью можно запросить информацию, содержащую различные данные карты, например ее срок действия карты, уникальный номер и пр.
Таким образом во время выполнения платежной транзакции получаются все необходимые данные.
Для подобных целей обычно используется команда READ RECORD, после предварительного выбора приложение для работы с памятью по его AID.
Для выбора конкретного приложения необходимо указать AID (Application Identifier) при использовании команды SELECT.
В ответе на данную команду карта сообщает об успешном или неуспешном выборе приложения~\cite{medium_apdu2_1}.


\subsubsection{Технология NFC}

Near-field communication (NFC) - это технология беспроводной связи малого радиуса действия, которая позволяет передавать данные между двумя устройствами, находящимися на расстоянии до 20 сантиметров.
Данная технология представляет собой набор протоколов связи, которые обеспечивают низкоскоростное соединение с простым и быстрым подключением.
Подобно другим технологиям карт ближнего взаимодействия, NFC основана на индуктивной связи между двумя электромагнитными катушками, встроенными в устройства с поддержкой NFC, такие как смартфоны.
Для обмена данными в одном или обоих направлениях NFC использует частоту 13,56 МГц, находящуюся в глобально доступном нелицензируемом диапазоне ISM (Industrial, Scientific and Medical).
Этот стандарт соответствует спецификации ISO/IEC 18000--3 и поддерживает скорости передачи данных от 106 до 848 кбит/с~\cite{nfc_wiki}.
Данная технология получила широкое применение в сфере бесконтактной оплаты.

Технология NFC охватывает как протоколы связи, так и форматы обмена данными.
Они основаны на существующих стандартах радиочастотной идентификации (RFID), в частности ISO/IEC 14443.
NFC описана в стандарте ISO/IEC 18092 и ряде других стандартов, разработанных объединением <<NFC Forum>>.
Структура данной технологии представлена на рисунке~\ref{fig:nfc_tech}, где изображено разделение на различные слои, начиная с физического уровня и заканчивая уровнем приложений (снизу вверх).
Каждый из описанных уровней связан с определёнными стандартами и обеспечивает целостность работы технологии NFC, начиная с физической передачи сигнала и заканчивая выполнением прикладных задач.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/research/nfc_tech}
    \caption{\centering Стек протоколов NFC}
    \label{fig:nfc_tech}
\end{figure}

Важно, что данная технология реализует ISO/IEC 14443 и ISO/IEC 7816~--- это позволяет устройствам, содержащим модуль NFC 4-го типа (NFC Type 4 Tag) использоваться для бесконтактной оплаты, т.к. данные модули совместимы с терминалами оплаты.


\subsubsection{EMV Contactless}

В соответствии с требованиями безопасности ЦБ РФ и ФСБ РФ требования к протоколу обмена между платежным устройством и бесконтактной картой описаны в следующих спецификациях:

\begin{itemize}
    \item EMV Contactless Specifications for Payment Systems.\ Book A.\ Architecture and general requirements;
    \item EMV Contactless Specifications for Payment Systems.\ Book B.\ Entry Point Specification;
    \item EMV Contactless Specifications for Payment Systems.\ Book C-2.\ Kernel 8 Specifications.
\end{itemize}

\subsubsection{3DES}
\subsubsection{MirAccept}


\subsubsection{PCI DSS}





\subsection{Анализ существующих решений}

\subsubsection{POS-терминалы}

POS-терминал (от англ.\ Point of Sale, точка продаж)~--- это устройство, предназначенное для приема безналичных платежей с использованием платежных средств, поддерживающих соответствующие терминалу технологии.
POS-терминалы широко используются в розничной торговле, ресторанах, транспорте и других сферах, где требуется осуществление платежей.

Основные функции POS-терминалов:

\begin{itemize}
    \item инициация взаимодействия с платежным средством (карта, смартфон и прочее);
    \item обмен данными с платежным средством, получение данных для формирования транзакции;
    \item связь с банком (напрямую или с помощью устройства-хоста) для авторизации и выполнения транзакций;
    \item выдача чека потребителю (в печатном или электронном виде), возврат ошибки платежа;
    \item обеспечение безопасности платежа, в соответствии со стандартом EMV.
\end{itemize}

POS-терминалы имеют различную структуру, однако можно выделить обобщенную структуру данного устройства.
Она представлена на рисунке~\ref{fig:postrem_struct}.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/research/postrem_struct}
    \caption{\centering Распространенная структура POS-терминала}
    \label{fig:postrem_struct}
\end{figure}

К обязательным элементам данного устройства можно отнести следующие:

\begin{itemize}
    \item RFID считыватель для обнаружения и связи со средствами платежа бесконтактным образом;
    \item элемент безопасности (криптографический модуль, SAM-модуль) для сохранения конфиденциальной платежной информации;
    \item модули проводной и/или беспроводной связи для связи с устройством-хостом или прямой связи с банком-эквайером.
\end{itemize}

Стоит отметить, что работа подобного устройства не возможна без программного обеспечения, интегрированного в POS-систему, которое управляет формированием и обработкой транзакций, шифрованием данных, запросами на авторизацию и связь с платежными сетями.

Мобильный эквайринг активно развивается и следствием этого явилось появление mPOS-терминалов и softPOS-терминалов:

\begin{itemize}
    \item mPOS-терминал~-- это портативное устройство, часто смартфон или планшет, оснащенное программным и аппаратным обеспечением, которое позволяет выполнять транзакции;
    \item softPOS терминал~-- это программное решение, с помощью которого мобильное устройство с поддержкой NFC (как правило смартфон или планшет) выступает в роли платежного терминала, т.е. принимает бесконтактные средства платежа, используя встроенный модуль NFC, и осуществляет выполнение платежных транзакций~\cite{pos_term}.
\end{itemize}

Детальное сравнение разновидностей POS-терминалов приведено в таблице~\ref{tab:pos_comparison}.

\begin{table}[H]
    \caption{Сравнение POS, mPOS и SoftPOS терминалов}
    \label{tab:pos_comparison}
    \begin{sloppypar}
        \centering
        \begin{tabularx}{\textwidth}{ | >{\raggedright\arraybackslash}X | >{\raggedright\arraybackslash}X | >{\raggedright\arraybackslash}X | >{\raggedright\arraybackslash}X | }
            \hline
            \textbf{Особенность} & \textbf{POS-терминалы} & \textbf{mPOS-терминалы} & \textbf{SoftPOS-терминалы} \\
            \hline
            Требования к оборудованию & специальные аппаратные компоненты & мобильное устройство с внешним считывателем карт & смартфон или планшет \\
            \hline
            Мобильность & закреплены на торговых точках & могут переносится & могут переносится \\
            \hline
            Методы оплаты & не только бесконтактные платежи & бесконтактные платежи и поддержка приложений цифровых кошельков & бесконтактные платежи и поддержка приложений цифровых кошельков \\
            \hline
            Особенности настройки & необходимость интеграции с сетью и окружением & требуется установка приложения и подключение считывателя карт & только установка приложения \\
            \hline
            Пользовательский интерфейс & отдельный экран устройства & экран мобильного устройства & экран мобильного устройства \\
            \hline
        \end{tabularx}
    \end{sloppypar}
\end{table}


\subsubsection{Сравнение существующих устройств}
% смотри раздел эквайринг и про 2can



\subsection{Формирование требований к системе}


